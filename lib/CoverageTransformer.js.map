{"version":3,"sources":["../src/CoverageTransformer.js"],"names":["sourceMapRegEx","CoverageTransformer","options","basePath","warn","console","exclude","fileName","indexOf","match","mapFileName","useAbsolutePaths","readJSON","filePath","existsSync","Error","JSON","parse","readFileSync","readFile","sourceStore","sources","sparceCoverageCollector","fileCoverage","rawSourceMap","sourceMapDir","dirname","codeIsArray","inputSourceMap","codeFromFile","jsText","code","Array","isArray","join","exec","Buffer","toString","sourceMapPath","String","split","error","setCoverage","map","srcPath","tempVal","sourceRoot","test","substr","resolve","sourceMap","inlineSourceMap","origSourceFilename","origFileName","sourcesContent","extname","length","file","replace","forEach","source","idx","setSourceCode","set","resolvePath","resolvedSource","relative","process","cwd","getMappingResolved","location","mapping","Object","assign","keys","branchMap","index","genItem","hits","b","info","updateBranch","srcItem","fnMap","f","updateFunction","statementMap","s","updateStatement","loc","srcCoverage","getFinalCoverage","getPath","absolutePath","fullSourceMapPath","path","item","addFileCoverage","collector","filter","filename","coverage","get","add"],"mappings":"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","file":"CoverageTransformer.js","sourcesContent":["import { Collector } from '../utils/node!istanbul';\r\nimport path from '../utils/node!path';\r\nimport fs from '../utils/node!fs';\r\nimport { SourceMapConsumer } from '../utils/node!source-map';\r\nimport SparceCoverageCollector from './SparceCoverageCollector';\r\nimport getMapping from './getMapping';\r\nimport remapFunction from './remapFunction';\r\nimport remapBranch from './remapBranch';\r\n\r\nconst sourceMapRegEx = /(?:\\/{2}[#@]{1,2}|\\/\\*)\\s+sourceMappingURL\\s*=\\s*(data:(?:[^;]+;)+base64,)?(\\S+)(?:\\n\\s*)?$/;\r\n\r\nexport default class CoverageTransformer {\r\n\tconstructor(options) {\r\n\t\tthis.basePath = options.basePath;\r\n\t\tthis.warn = options.warn || console.warn;\r\n\r\n\t\tthis.exclude = () => false;\r\n\t\tif (options.exclude) {\r\n\t\t\tif (typeof options.exclude === 'function') {\r\n\t\t\t\tthis.exclude = options.exclude;\r\n\t\t\t} else if (typeof options.exclude === 'string') {\r\n\t\t\t\tthis.exclude = (fileName) => fileName.indexOf(options.exclude) > -1;\r\n\t\t\t} else {\r\n\t\t\t\tthis.exclude = (fileName) => fileName.match(options.exclude);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.mapFileName = options.mapFileName || ((fileName) => fileName);\r\n\r\n\t\tthis.useAbsolutePaths = !!options.useAbsolutePaths;\r\n\r\n\t\tthis.readJSON = options.readJSON\r\n\t\t\t|| function readJSON(filePath) {\r\n\t\t\t\tif (!fs.existsSync(filePath)) {\r\n\t\t\t\t\tthis.warn(Error(`Could not find file: \"${filePath}\"`));\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\treturn JSON.parse(fs.readFileSync(filePath));\r\n\t\t\t};\r\n\r\n\t\tthis.readFile = options.readFile\r\n\t\t\t|| function readFile(filePath) {\r\n\t\t\t\tif (!fs.existsSync(filePath)) {\r\n\t\t\t\t\tthis.warn(new Error(`Could not find file: \"${filePath}\"`));\r\n\t\t\t\t\treturn '';\r\n\t\t\t\t}\r\n\t\t\t\treturn fs.readFileSync(filePath);\r\n\t\t\t};\r\n\r\n\t\tthis.sourceStore = options.sources;\r\n\r\n\t\tthis.sparceCoverageCollector = new SparceCoverageCollector();\r\n\t}\r\n\r\n\taddFileCoverage(filePath, fileCoverage) {\r\n\t\tif (this.exclude(filePath)) {\r\n\t\t\tthis.warn(`Excluding: \"${filePath}\"`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tlet rawSourceMap;\r\n\t\tlet sourceMapDir = path.dirname(filePath);\r\n\t\tlet codeIsArray = true;\r\n\t\tif (fileCoverage.inputSourceMap) {\r\n\t\t\trawSourceMap = fileCoverage.inputSourceMap;\r\n\t\t} else {\r\n\t\t\t/* coverage.json can sometimes include the code inline */\r\n\t\t\tlet codeFromFile = false;\r\n\t\t\tlet jsText = fileCoverage.code;\r\n\t\t\tif (!jsText) {\r\n\t\t\t\tjsText = this.readFile(filePath);\r\n\t\t\t\tcodeFromFile = true;\r\n\t\t\t}\r\n\t\t\tif (Array.isArray(jsText)) { /* sometimes the source is an array */\r\n\t\t\t\tjsText = jsText.join('\\n');\r\n\t\t\t} else {\r\n\t\t\t\tcodeIsArray = false;\r\n\t\t\t}\r\n\t\t\tlet match = sourceMapRegEx.exec(jsText);\r\n\r\n\t\t\tif (!match && !codeFromFile) {\r\n\t\t\t\tcodeIsArray = false;\r\n\t\t\t\tjsText = this.readFile(filePath);\r\n\t\t\t\tmatch = sourceMapRegEx.exec(jsText);\r\n\t\t\t}\r\n\r\n\t\t\tif (match) {\r\n\t\t\t\tif (match[1]) {\r\n\t\t\t\t\trawSourceMap = JSON.parse((new Buffer(match[2], 'base64').toString('utf8')));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst sourceMapPath = path.join(sourceMapDir, match[2]);\r\n\t\t\t\t\trawSourceMap = this.readJSON(sourceMapPath);\r\n\t\t\t\t\tsourceMapDir = path.dirname(sourceMapPath);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!rawSourceMap) {\r\n\t\t\t/* We couldn't find a source map, so will copy coverage after warning. */\r\n\t\t\tthis.warn(new Error(`Could not find source map for: \"${filePath}\"`));\r\n\t\t\ttry {\r\n\t\t\t\tfileCoverage.code = String(fs.readFileSync(filePath)).split('\\n');\r\n\t\t\t} catch (error) {\r\n\t\t\t\tthis.warn(new Error(`Could find source for : \"${filePath}\"`));\r\n\t\t\t}\r\n\t\t\tthis.sparceCoverageCollector.setCoverage(filePath, fileCoverage);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsourceMapDir = this.basePath || sourceMapDir;\r\n\r\n\t\t// Clean up source map paths:\r\n\t\t// * prepend sourceRoot if it is set\r\n\t\t// * replace relative paths in source maps with absolute\r\n\t\trawSourceMap.sources = rawSourceMap.sources.map((srcPath) => {\r\n\t\t\tlet tempVal = srcPath;\r\n\t\t\tif (rawSourceMap.sourceRoot) {\r\n\t\t\t\ttempVal = /\\/$/g.test(rawSourceMap.sourceRoot)\r\n\t\t\t\t\t? rawSourceMap.sourceRoot + srcPath\r\n\t\t\t\t\t: srcPath;\r\n\t\t\t}\r\n\t\t\treturn tempVal.substr(0, 1) === '.'\r\n\t\t\t\t? path.resolve(sourceMapDir, tempVal)\r\n\t\t\t\t: tempVal\r\n\t\t});\r\n\r\n\t\tlet sourceMap = new SourceMapConsumer(rawSourceMap);\r\n\r\n\t\t/* if there are inline sources and a store to put them into, we will populate it */\r\n\t\tconst inlineSourceMap = {};\r\n\t\tlet origSourceFilename;\r\n\t\tlet origFileName;\r\n\t\tlet fileName;\r\n\r\n\t\tif (sourceMap.sourcesContent) {\r\n\t\t\torigSourceFilename = rawSourceMap.sources[0];\r\n\r\n\t\t\tif (origSourceFilename && path.extname(origSourceFilename) !== '' && rawSourceMap.sources.length === 1) {\r\n\t\t\t\torigFileName = rawSourceMap.file;\r\n\t\t\t\tfileName = filePath.replace(path.extname(origFileName), path.extname(origSourceFilename));\r\n\t\t\t\trawSourceMap.file = fileName;\r\n\t\t\t\trawSourceMap.sources = [fileName];\r\n\t\t\t\trawSourceMap.sourceRoot = '';\r\n\t\t\t\tsourceMap = new SourceMapConsumer(rawSourceMap);\r\n\t\t\t}\r\n\r\n\t\t\tsourceMap.sourcesContent.forEach((source, idx) => {\r\n\t\t\t\tinlineSourceMap[sourceMap.sources[idx]] = true;\r\n\t\t\t\tthis.sparceCoverageCollector.setSourceCode(\r\n\t\t\t\t\tsourceMap.sources[idx],\r\n\t\t\t\t\tcodeIsArray ? source.split('\\n') : source\r\n\t\t\t\t);\r\n\t\t\t\tif (this.sourceStore) {\r\n\t\t\t\t\tthis.sourceStore.set(sourceMap.sources[idx], source);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst resolvePath = (source) => {\r\n\t\t\tlet resolvedSource = source in inlineSourceMap\r\n\t\t\t\t? source\r\n\t\t\t\t: path.resolve(sourceMapDir, source);\r\n\r\n\t\t\tif (!this.useAbsolutePaths && !(source in inlineSourceMap)) {\r\n\t\t\t\tresolvedSource = path.relative(process.cwd(), resolvedSource);\r\n\t\t\t}\r\n\t\t\treturn resolvedSource;\r\n\t\t};\r\n\r\n\t\tconst getMappingResolved = (location) => {\r\n\t\t\tconst mapping = getMapping(sourceMap, location);\r\n\t\t\tif (!mapping) return null;\r\n\r\n\t\t\treturn Object.assign(mapping, { source: resolvePath(mapping.source) });\r\n\t\t};\r\n\r\n\t\tObject.keys(fileCoverage.branchMap).forEach((index) => {\r\n\t\t\tconst genItem = fileCoverage.branchMap[index];\r\n\t\t\tconst hits = fileCoverage.b[index];\r\n\r\n\t\t\tconst info = remapBranch(genItem, getMappingResolved);\r\n\r\n\t\t\tif (info) {\r\n\t\t\t\tthis.sparceCoverageCollector.updateBranch(info.source, info.srcItem, hits);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tObject.keys(fileCoverage.fnMap).forEach((index) => {\r\n\t\t\tconst genItem = fileCoverage.fnMap[index];\r\n\t\t\tconst hits = fileCoverage.f[index];\r\n\r\n\t\t\tconst info = remapFunction(genItem, getMappingResolved);\r\n\r\n\t\t\tif (info) {\r\n\t\t\t\tthis.sparceCoverageCollector.updateFunction(info.source, info.srcItem, hits);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tObject.keys(fileCoverage.statementMap).forEach((index) => {\r\n\t\t\tconst genItem = fileCoverage.statementMap[index];\r\n\t\t\tconst hits = fileCoverage.s[index];\r\n\r\n\t\t\tconst mapping = getMappingResolved(genItem);\r\n\r\n\t\t\tif (mapping) {\r\n\t\t\t\tthis.sparceCoverageCollector.updateStatement(mapping.source, mapping.loc, hits);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// todo: refactor exposing implementation details\r\n\t\tconst srcCoverage = this.sparceCoverageCollector.getFinalCoverage();\r\n\r\n\t\tif (sourceMap.sourcesContent && this.basePath && origFileName) {\r\n\t\t\t// Convert path to use base path option\r\n\t\t\tconst getPath = filePath => {\r\n\t\t\t\tconst absolutePath = path.resolve(this.basePath, filePath);\r\n\t\t\t\tif (!this.useAbsolutePaths) {\r\n\t\t\t\t\treturn path.relative(process.cwd(), absolutePath);\r\n\t\t\t\t}\r\n\t\t\t\treturn absolutePath;\r\n\t\t\t};\r\n\t\t\tconst fullSourceMapPath = getPath(\r\n\t\t\t\torigFileName.replace(path.extname(origFileName), path.extname(origSourceFilename))\r\n\t\t\t);\r\n\t\t\tsrcCoverage[fullSourceMapPath] = srcCoverage[fileName];\r\n\t\t\tsrcCoverage[fullSourceMapPath].path = fullSourceMapPath;\r\n\t\t\tdelete srcCoverage[fileName];\r\n\t\t}\r\n\t}\r\n\r\n\taddCoverage(item) {\r\n\t\tObject.keys(item)\r\n\t\t\t.forEach((filePath) => {\r\n\t\t\t\tconst fileCoverage = item[filePath];\r\n\t\t\t\tthis.addFileCoverage(filePath, fileCoverage);\r\n\t\t\t});\r\n\t}\r\n\r\n\tgetFinalCoverage() {\r\n\t\tconst collector = new Collector();\r\n\r\n\t\tconst srcCoverage = this.sparceCoverageCollector.getFinalCoverage();\r\n\r\n\t\tObject.keys(srcCoverage)\r\n\t\t\t.filter((filePath) => !this.exclude(filePath))\r\n\t\t\t.forEach((filename) => {\r\n\t\t\t\tconst coverage = Object.assign({}, srcCoverage[filename]);\r\n\t\t\t\tcoverage.path = this.mapFileName(filename);\r\n\t\t\t\tif (this.sourceStore && coverage.path !== filename) {\r\n\t\t\t\t\tconst source = this.sourceStore.get(filename);\r\n\t\t\t\t\tthis.sourceStore.set(coverage.path, source);\r\n\t\t\t\t}\r\n\t\t\t\tcollector.add({\r\n\t\t\t\t\t[coverage.path]: coverage\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t/* refreshes the line counts for reports */\r\n\t\tcollector.getFinalCoverage();\r\n\r\n\t\treturn collector;\r\n\t}\r\n}\r\n"]}