{"version":3,"sources":["../src/gulpRemapIstanbul.js"],"names":["gulpPlugin","opts","obj","file","enc","cb","warn","message","fail","console","error","sources","isNull","isStream","collector","JSON","parse","contents","toString","thresholdCheckFailed","check","Object","keys","map","length","p","reports","forEach","key","push","reportOpts","Buffer","stringify","getFinalCoverage","Promise","all","then"],"mappings":";;;;;;;oBAWwBA,U;;;;;;;;;;;;;;;;;;AAFxB;;AATA;AACA;AAUe,WAASA,UAAT,GAA+B;AAAA,OAAXC,IAAW,uEAAJ,EAAI;;AAC7C,UAAO,sBAAQC,GAAR,CAAY,UAACC,IAAD,EAAOC,GAAP,EAAYC,EAAZ,EAAmB;AACrC,QAAI,CAACJ,KAAKK,IAAV,EAAgB;AACfL,UAAKK,IAAL,GAAY,UAACC,OAAD,EAAa;AACxB,UAAIN,KAAKO,IAAT,EAAe;AACdH,UAAG,8BAAgB,gBAAhB,EAAkCE,OAAlC,CAAH;AACA,OAFD,MAEO;AACNE,eAAQC,KAAR,CAAcH,OAAd;AACA;AACD,MAND;AAOA;;AAEDN,SAAKU,OAAL,GAAe,sBAAf;;AAEA,QAAIR,KAAKS,MAAL,EAAJ,EAAmB;AAClBP,QAAG,IAAH,EAASF,IAAT;AACA;;AAED,QAAIA,KAAKU,QAAL,EAAJ,EAAqB;AACpBR,QAAG,8BAAgB,gBAAhB,EAAkC,yBAAlC,CAAH;AACA;;AAED,QAAMS,YAAY,qBAAMC,KAAKC,KAAL,CAAWb,KAAKc,QAAL,CAAcC,QAAd,CAAuB,MAAvB,CAAX,CAAN,EAAkDjB,IAAlD,CAAlB;;AAEA,QAAIkB,uBAAuB,KAA3B;AACA,QAAIlB,KAAKmB,KAAT,EAAgB;AACfD,4BAAuB,8BAAelB,KAAKmB,KAApB,EAA2BN,SAA3B,CAAvB;AACA;;AAED,QAAIH,gBAAJ;AACA,QAAIU,OAAOC,IAAP,CAAYrB,KAAKU,OAAL,CAAaY,GAAzB,EAA8BC,MAAlC,EAA0C;AACzCb,eAAUV,KAAKU,OAAf;AACA;;AAED,QAAMc,IAAI,EAAV;AACA,QAAIxB,KAAKyB,OAAT,EAAkB;AACjBL,YAAOC,IAAP,CAAYrB,KAAKyB,OAAjB,EAA0BC,OAA1B,CAAkC,UAACC,GAAD,EAAS;AAC1CH,QAAEI,IAAF,CAAO,2BAAYf,SAAZ,EAAuBc,GAAvB,EAA4B3B,KAAK6B,UAAL,IAAmB,EAA/C,EAAmD7B,KAAKyB,OAAL,CAAaE,GAAb,CAAnD,EAAsEjB,OAAtE,CAAP;AACA,MAFD;AAGA;;AAEDR,SAAKc,QAAL,GAAgB,IAAIc,MAAJ,CAAWhB,KAAKiB,SAAL,CAAelB,UAAUmB,gBAAV,EAAf,CAAX,CAAhB;;AAEAC,YAAQC,GAAR,CAAYV,CAAZ,EAAeW,IAAf,CAAoB,YAAM;AACzB,SAAIjB,oBAAJ,EAA0B;AACzB,aAAOd,GAAG,8BAAgB,gBAAhB,EAAkC,4BAAlC,CAAH,CAAP;AACA,MAFD,MAEO;AACNA,SAAG,IAAH,EAASF,IAAT;AACA;AACD,KAND;AAOA,IAjDM,CAAP;AAkDA","file":"gulpRemapIstanbul.js","sourcesContent":["/* jshint node: true */\r\n/* jshint -W079 */\r\nimport remap from './remap';\r\nimport writeReport from './writeReport';\r\nimport checkThreshold from './checkThreshold';\r\nimport MemoryStore from '../utils/node!istanbul/lib/store/memory';\r\nimport { PluginError } from '../utils/node!gulp-util';\r\nimport through from '../utils/node!through2';\r\n\r\n/* global Promise */\r\n\r\nexport default function gulpPlugin(opts = {}) {\r\n\treturn through.obj((file, enc, cb) => {\r\n\t\tif (!opts.warn) {\r\n\t\t\topts.warn = (message) => {\r\n\t\t\t\tif (opts.fail) {\r\n\t\t\t\t\tcb(new PluginError('remap-istanbul', message));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(message);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\topts.sources = new MemoryStore();\r\n\r\n\t\tif (file.isNull()) {\r\n\t\t\tcb(null, file);\r\n\t\t}\r\n\r\n\t\tif (file.isStream()) {\r\n\t\t\tcb(new PluginError('remap-istanbul', 'Streaming not supported'));\r\n\t\t}\r\n\r\n\t\tconst collector = remap(JSON.parse(file.contents.toString('utf8')), opts);\r\n\r\n\t\tlet thresholdCheckFailed = false;\r\n\t\tif (opts.check) {\t\t\t\t\r\n\t\t\tthresholdCheckFailed = checkThreshold(opts.check, collector);\r\n\t\t}\r\n\r\n\t\tlet sources;\r\n\t\tif (Object.keys(opts.sources.map).length) {\r\n\t\t\tsources = opts.sources;\r\n\t\t}\r\n\r\n\t\tconst p = [];\r\n\t\tif (opts.reports) {\r\n\t\t\tObject.keys(opts.reports).forEach((key) => {\r\n\t\t\t\tp.push(writeReport(collector, key, opts.reportOpts || {}, opts.reports[key], sources));\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfile.contents = new Buffer(JSON.stringify(collector.getFinalCoverage()));\r\n\r\n\t\tPromise.all(p).then(() => {\r\n\t\t\tif (thresholdCheckFailed) {\r\n\t\t\t\treturn cb(new PluginError('remap-istanbul', 'Coverage threshold not met'));\t\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\tcb(null, file);\r\n\t\t\t}\t\t\t\r\n\t\t});\r\n\t});\r\n};\r\n"]}